(()=>{"use strict";new ModelFormat({id:"makriva_shape",name:"Makriva Shape",description:"Model for Makriva mod",icon:"icon-player",rotate_cubes:!0,box_uv:!0,optional_box_uv:!1,single_texture:!0,bone_rig:!0,centered_grid:!0,locators:!0,display_mode:!1,animation_mode:!0,codec:Codecs.project});let e={skinUrl:"",slimModel:!1,hideHead:!1,hideBody:!1,hideLeftArm:!1,hideRightArm:!1,hideLeftLeg:!1,hideRightLeg:!1};const o={head:[0,24,0],body:[0,24,0],left_arm:[-5,22,0],right_arm:[5,22,0],left_leg:[-1.9,12,0],right_leg:[1.9,12,0]};function i(e){return!e||0==e[0]&&0==e[1]&&0==e[2]}function t(e){return e.to[0]==e.from[0]||e.to[1]==e.from[1]||e.to[2]==e.from[2]}function n(e,o){return{pos:[o.origin[0]-e.to[0],o.origin[1]-e.to[1],e.from[2]-o.origin[2]],size:[e.to[0]-e.from[0],e.to[1]-e.from[1],e.to[2]-e.from[2]],uv:e.uv_offset,delta:0!==e.inflate?e.inflate:void 0,mirror:!!e.mirror_uv||void 0}}function r(e,o){return{pos:[o.origin[0]-e.to[0],o.origin[1]-e.to[1],e.from[2]-o.origin[2]],size:[e.to[0]-e.from[0],e.to[1]-e.from[1],e.to[2]-e.from[2]],uv:[e.uv_offset[0]+(e.to[1]==e.from[1]?e.to[2]-e.from[2]:0),e.uv_offset[1]+(e.to[0]==e.from[0]?e.to[2]-e.from[2]:0)],delta:0!==e.inflate?e.inflate:void 0,mirror:!!e.mirror_uv||void 0}}function a(e,o,a){const d={id:e.name,parent:a,rotation:[-e.rotation[0],-e.rotation[1],e.rotation[2]],rotationPoint:[o.origin[0]-e.origin[0],o.origin[1]-e.origin[1],e.origin[2]-o.origin[2]]},l=e=>{e.pos[0]-=d.rotationPoint[0],e.pos[1]-=d.rotationPoint[1],e.pos[2]-=d.rotationPoint[2]};if(t(e)){const i=r(e,o);l(i),d.quads=[i]}else{const i=n(e,o);l(i),d.cubes=[i]}return i(d.rotationPoint)&&(d.rotationPoint=void 0),d}function d(e,o,l){const s={id:e.name,parent:l,rotationPoint:[o.origin[0]-e.origin[0],o.origin[1]-e.origin[1],e.origin[2]-o.origin[2]],rotation:[-e.rotation[0],-e.rotation[1],e.rotation[2]],cubes:[],quads:[],bones:[]};for(const o of Object.values(e.children)){if(!o.export)continue;if(o instanceof Group){s.bones.push(d(o,e));continue}const l=o;i(l.rotation)?t(l)?s.quads.push(r(l,e)):s.cubes.push(n(l,e)):s.bones.push(a(l,e))}return i(s.rotationPoint)&&(s.rotationPoint=void 0),i(s.rotation)&&(s.rotation=void 0),0==s.cubes.length&&(s.cubes=void 0),0==s.quads.length&&(s.quads=void 0),0==s.bones.length&&(s.bones=void 0),s}function l(){const e={};for(const t of Object.values(Outliner.root)){if(!(t instanceof Group))continue;if(!(t.name in o))continue;if(!t.export)continue;const n=t,r=t.name,a=o[r],d=[a[0]-n.origin[0],a[1]-n.origin[1],n.origin[2]-a[2]];i(d)||(e[r]=d)}return e}const s=new Codec("makriva",{name:"Makriva shape",extension:"json",remember:!1,compile:function(){if(!Project)return"{}";const i={metadata:{},textures:{skin:e.skinUrl},textureSize:[Project.texture_width,Project.texture_height],hide:[],skeleton:l(),boundingBox:{},animation:{},bones:[]};e.slimModel&&(i.metadata.model="slim"),e.hideHead&&i.hide.push("head"),e.hideBody&&i.hide.push("body"),e.hideLeftArm&&i.hide.push("left_arm"),e.hideRightArm&&i.hide.push("right_arm"),e.hideLeftLeg&&i.hide.push("left_leg"),e.hideRightLeg&&i.hide.push("right_leg");for(const e of Object.values(Outliner.root)){if(!(e instanceof Group))continue;if(!(e.name in o))continue;if(!(e.children instanceof Array))continue;if(!e.export)continue;const t=e,n=e.name,r={origin:[t.origin[0],t.origin[1],t.origin[2]]};for(const o of Object.values(e.children))o.export&&(o instanceof Group?i.bones.push(d(o,r,n)):o instanceof Cube&&i.bones.push(a(o,r,n)))}return autoStringify(i)}}),c=new Action("makriva_export",{name:"Export Makriva Shape",category:"file",icon:"icon-player",click:function(){if(Project){if(Project.textures.length>0){const o=Project.textures[0];e.skinUrl="file:makriva/"+o.name}new Dialog({id:"makriva_export",title:"Makriva Shape Export",form:{skinUrl:{label:"Skin URL",type:"text",value:e.skinUrl},slimModel:{label:"Slim model",type:"checkbox",value:e.slimModel},hideHead:{label:"Hide Head",type:"checkbox",value:e.hideHead},hideBody:{label:"Hide Body",type:"checkbox",value:e.hideBody},hideRightArm:{label:"Hide Right Arm",type:"checkbox",value:e.hideRightArm},hideLeftArm:{label:"Hide Left Arm",type:"checkbox",value:e.hideLeftArm},hideRightLeg:{label:"Hide Right Leg",type:"checkbox",value:e.hideRightLeg},hideLeftLeg:{label:"Hide Left Leg",type:"checkbox",value:e.hideLeftLeg}},onConfirm:function(o){e=o,s.export(),this.hide()}}).show()}}}),u=new Toggle("paint_exploded_view",{icon:()=>"open_in_full",category:"edit",condition:{modes:["paint"]},name:"Exploded View (Makriva)",description:"Toggles an exploded view that allows you to edit covered faces",value:!1,onChange(e){Project&&(Undo.initEdit({elements:Cube.all,exploded_view:!e}),Cube.all.forEach((o=>{const i=o.name.toLowerCase().includes("leg")?1:.5,t=e?i:-i/(1+i),n=[o.from[0]+(o.to[0]-o.from[0])/2,o.from[1],o.from[2]+(o.to[2]-o.from[2])/2];n.V3_multiply(t,t,t),o.from.V3_add(n),o.to.V3_add(n)})),Project.exploded_view=e,Undo.finishEdit(e?"Explode skin model":"Revert exploding skin model",{elements:Cube.all,exploded_view:e}),Canvas.updateView({elements:Cube.all,element_aspects:{geometry:!0}}),this.setIcon(this.icon))}});BBPlugin.register("makriva",{title:"Makriva plugin",author:"msifeed",description:"Export model to Makriva shape",icon:"icon-player",version:"0.2.2",variant:"both",onload:()=>{MenuBar.addAction(c,"file.export"),(()=>{if(Blockbench.on("select_project",(()=>{Project&&(u.value=Project.exploded_view,u.updateEnabledState())})),Toolbars.outliner.children.some((e=>e.id===u.id)))return;const e=Toolbars.outliner.children.map((e=>e.id)).indexOf("explode_skin_model");-1!==e?u.pushToolbar(Toolbars.outliner,e):u.pushToolbar(Toolbars.outliner)})()},onunload:()=>{u.delete(),c.delete()}})})();